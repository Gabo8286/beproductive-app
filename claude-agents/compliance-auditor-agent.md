# Compliance Auditor Agent ðŸ“‹

## Purpose
Automate regulatory compliance verification, conduct privacy audits, validate data governance policies, and ensure adherence to industry standards like GDPR, CCPA, SOC 2, and other regulatory frameworks.

## Capabilities
- GDPR/CCPA compliance verification
- Data privacy policy validation
- Audit trail generation and analysis
- Third-party vendor compliance assessment
- Regulatory gap analysis
- Privacy impact assessments
- Data retention policy enforcement
- Consent management validation
- Access rights verification
- Compliance reporting automation

## Tech Stack & Tools
- **Privacy**: OneTrust, TrustArc, Privacera
- **Audit Logging**: AWS CloudTrail, Azure Monitor
- **Compliance**: Vanta, Drata, SecureFrame
- **Data Discovery**: Microsoft Purview, Varonis
- **Assessment**: Custom compliance frameworks
- **Reporting**: Automated compliance dashboards

## Compliance Testing Templates

### 1. GDPR Compliance Testing
```typescript
import { describe, it, expect } from 'vitest';
import { supabase } from '@/integrations/supabase/client';

describe('GDPR Compliance Testing', () => {\n  it('should handle data subject access requests', async () => {\n    const complianceAuditor = new GDPRComplianceAuditor();\n    const testUserId = 'test-user-gdpr-123';\n    \n    // Create test user data across multiple tables\n    await createTestUserData(testUserId);\n    \n    // Submit data access request\n    const accessRequest = await complianceAuditor.submitDataAccessRequest({\n      userId: testUserId,\n      requestType: 'access',\n      requesterEmail: 'user@example.com'\n    });\n    \n    expect(accessRequest.requestId).toBeDefined();\n    expect(accessRequest.status).toBe('submitted');\n    \n    // Process the request\n    const processingResult = await complianceAuditor.processAccessRequest(accessRequest.requestId);\n    \n    expect(processingResult.success).toBe(true);\n    expect(processingResult.completionTime).toBeLessThan(30 * 24 * 60 * 60 * 1000); // 30 days\n    \n    // Verify data completeness\n    const exportedData = processingResult.userData;\n    expect(exportedData.personalData).toBeDefined();\n    expect(exportedData.activityLogs).toBeDefined();\n    expect(exportedData.preferences).toBeDefined();\n    \n    // Verify data format (machine-readable)\n    expect(exportedData.format).toBe('JSON');\n    expect(exportedData.structure).toBe('structured');\n  });\n\n  it('should handle right to erasure requests', async () => {\n    const complianceAuditor = new GDPRComplianceAuditor();\n    const testUserId = 'test-user-erasure-456';\n    \n    // Create test user data\n    await createTestUserData(testUserId);\n    \n    // Verify data exists\n    const beforeErasure = await getUserData(testUserId);\n    expect(beforeErasure.length).toBeGreaterThan(0);\n    \n    // Submit erasure request\n    const erasureRequest = await complianceAuditor.submitErasureRequest({\n      userId: testUserId,\n      reason: 'withdrawal_of_consent',\n      exceptions: [] // No exceptions for this test\n    });\n    \n    expect(erasureRequest.status).toBe('submitted');\n    \n    // Process erasure\n    const erasureResult = await complianceAuditor.processErasureRequest(erasureRequest.requestId);\n    \n    expect(erasureResult.success).toBe(true);\n    expect(erasureResult.completionTime).toBeLessThan(30 * 24 * 60 * 60 * 1000); // 30 days\n    \n    // Verify data erasure\n    const afterErasure = await getUserData(testUserId);\n    expect(afterErasure.length).toBe(0);\n    \n    // Verify audit trail of erasure\n    const auditLog = await getAuditLog('data_erasure', testUserId);\n    expect(auditLog.length).toBeGreaterThan(0);\n    expect(auditLog[0].action).toBe('data_erased');\n    expect(auditLog[0].reason).toBe('withdrawal_of_consent');\n  });\n\n  it('should validate consent management', async () => {\n    const consentManager = new ConsentManager();\n    const testUserId = 'test-user-consent-789';\n    \n    // Test initial consent collection\n    const consentData = {\n      userId: testUserId,\n      consentTypes: ['marketing', 'analytics', 'functional'],\n      timestamp: new Date(),\n      version: '1.0',\n      method: 'explicit'\n    };\n    \n    const consentResult = await consentManager.recordConsent(consentData);\n    expect(consentResult.success).toBe(true);\n    expect(consentResult.consentId).toBeDefined();\n    \n    // Verify consent storage\n    const storedConsent = await consentManager.getConsent(testUserId);\n    expect(storedConsent.consentTypes).toEqual(consentData.consentTypes);\n    expect(storedConsent.version).toBe('1.0');\n    \n    // Test consent withdrawal\n    const withdrawalResult = await consentManager.withdrawConsent(testUserId, ['marketing']);\n    expect(withdrawalResult.success).toBe(true);\n    \n    // Verify updated consent\n    const updatedConsent = await consentManager.getConsent(testUserId);\n    expect(updatedConsent.consentTypes).not.toContain('marketing');\n    expect(updatedConsent.consentTypes).toContain('analytics');\n    expect(updatedConsent.consentTypes).toContain('functional');\n    \n    // Verify audit trail\n    const consentAudit = await getAuditLog('consent_change', testUserId);\n    expect(consentAudit.length).toBeGreaterThan(0);\n  });\n\n  it('should enforce data retention policies', async () => {\n    const retentionPolicy = new DataRetentionPolicy();\n    \n    // Define retention rules\n    const rules = [\n      { dataType: 'user_activity', retentionPeriod: 365 }, // 1 year\n      { dataType: 'marketing_data', retentionPeriod: 1095 }, // 3 years\n      { dataType: 'financial_records', retentionPeriod: 2555 } // 7 years\n    ];\n    \n    await retentionPolicy.setRetentionRules(rules);\n    \n    // Create old test data\n    const oldData = await createOldTestData(400); // 400 days old\n    \n    // Run retention policy enforcement\n    const enforcementResult = await retentionPolicy.enforceRetention();\n    \n    expect(enforcementResult.success).toBe(true);\n    \n    // Verify old user activity data was deleted\n    const remainingActivityData = await queryDataByType('user_activity', 400);\n    expect(remainingActivityData.length).toBe(0);\n    \n    // Verify other data types still exist (within retention period)\n    const remainingMarketingData = await queryDataByType('marketing_data', 400);\n    expect(remainingMarketingData.length).toBeGreaterThan(0);\n    \n    // Verify audit log of retention enforcement\n    const retentionAudit = await getAuditLog('data_retention', null);\n    expect(retentionAudit.length).toBeGreaterThan(0);\n  });\n});\n```\n\n### 2. SOC 2 Compliance Testing\n```typescript\nimport { describe, it, expect } from 'vitest';\n\ndescribe('SOC 2 Compliance Testing', () => {\n  it('should validate security controls (Security Criteria)', async () => {\n    const soc2Auditor = new SOC2Auditor();\n    \n    // Test access controls\n    const accessControlsResult = await soc2Auditor.auditAccessControls();\n    expect(accessControlsResult.passwordPolicy.enforced).toBe(true);\n    expect(accessControlsResult.mfaEnabled).toBe(true);\n    expect(accessControlsResult.rbacImplemented).toBe(true);\n    expect(accessControlsResult.accessReviews.frequency).toBe('quarterly');\n    \n    // Test logical and physical access\n    const physicalAccessResult = await soc2Auditor.auditPhysicalAccess();\n    expect(physicalAccessResult.dataCenter.accessControls).toBe('compliant');\n    expect(physicalAccessResult.officeAccess.badgeSystem).toBe('active');\n    \n    // Test system operations\n    const operationsResult = await soc2Auditor.auditSystemOperations();\n    expect(operationsResult.changeManagement.documented).toBe(true);\n    expect(operationsResult.incidentResponse.planExists).toBe(true);\n    expect(operationsResult.backup.automated).toBe(true);\n    expect(operationsResult.monitoring.continuous).toBe(true);\n  });\n\n  it('should validate availability controls (Availability Criteria)', async () => {\n    const soc2Auditor = new SOC2Auditor();\n    \n    // Test system availability\n    const availabilityMetrics = await soc2Auditor.getAvailabilityMetrics();\n    expect(availabilityMetrics.uptime).toBeGreaterThan(99.9); // 99.9% uptime\n    expect(availabilityMetrics.mtbf).toBeGreaterThan(720); // > 720 hours MTBF\n    expect(availabilityMetrics.mttr).toBeLessThan(240); // < 4 hours MTTR\n    \n    // Test capacity management\n    const capacityResult = await soc2Auditor.auditCapacityManagement();\n    expect(capacityResult.capacityPlanning.documented).toBe(true);\n    expect(capacityResult.performanceMonitoring.implemented).toBe(true);\n    expect(capacityResult.scalingProcedures.automated).toBe(true);\n    \n    // Test business continuity\n    const bcpResult = await soc2Auditor.auditBusinessContinuity();\n    expect(bcpResult.disasterRecoveryPlan.exists).toBe(true);\n    expect(bcpResult.backupTesting.frequency).toBe('monthly');\n    expect(bcpResult.failoverTesting.frequency).toBe('quarterly');\n  });\n\n  it('should validate processing integrity (Processing Integrity Criteria)', async () => {\n    const soc2Auditor = new SOC2Auditor();\n    \n    // Test data processing controls\n    const processingResult = await soc2Auditor.auditDataProcessing();\n    expect(processingResult.inputValidation.implemented).toBe(true);\n    expect(processingResult.outputValidation.implemented).toBe(true);\n    expect(processingResult.errorHandling.documented).toBe(true);\n    \n    // Test data integrity\n    const integrityResult = await soc2Auditor.auditDataIntegrity();\n    expect(integrityResult.checksums.enabled).toBe(true);\n    expect(integrityResult.transactionLogs.maintained).toBe(true);\n    expect(integrityResult.reconciliation.automated).toBe(true);\n    \n    // Test processing authorization\n    const authorizationResult = await soc2Auditor.auditProcessingAuthorization();\n    expect(authorizationResult.approvalWorkflows.implemented).toBe(true);\n    expect(authorizationResult.segregationOfDuties.enforced).toBe(true);\n  });\n\n  it('should validate confidentiality controls (Confidentiality Criteria)', async () => {\n    const soc2Auditor = new SOC2Auditor();\n    \n    // Test data classification\n    const classificationResult = await soc2Auditor.auditDataClassification();\n    expect(classificationResult.dataInventory.complete).toBe(true);\n    expect(classificationResult.sensitivityLabels.applied).toBe(true);\n    expect(classificationResult.handlingProcedures.documented).toBe(true);\n    \n    // Test encryption\n    const encryptionResult = await soc2Auditor.auditEncryption();\n    expect(encryptionResult.dataAtRest.encrypted).toBe(true);\n    expect(encryptionResult.dataInTransit.encrypted).toBe(true);\n    expect(encryptionResult.keyManagement.secure).toBe(true);\n    \n    // Test access restrictions\n    const accessResult = await soc2Auditor.auditAccessRestrictions();\n    expect(accessResult.needToKnow.enforced).toBe(true);\n    expect(accessResult.dataLossPrevention.implemented).toBe(true);\n  });\n});\n```\n\n### 3. Data Privacy Compliance Testing\n```typescript\nimport { describe, it, expect } from 'vitest';\n\ndescribe('Data Privacy Compliance Testing', () => {\n  it('should validate privacy by design implementation', async () => {\n    const privacyAuditor = new PrivacyAuditor();\n    \n    // Test data minimization\n    const dataMinimizationResult = await privacyAuditor.auditDataMinimization();\n    expect(dataMinimizationResult.collectionPurpose.documented).toBe(true);\n    expect(dataMinimizationResult.excessiveDataCollection.found).toBe(false);\n    expect(dataMinimizationResult.purposeLimitation.enforced).toBe(true);\n    \n    // Test privacy impact assessments\n    const piaResult = await privacyAuditor.auditPrivacyImpactAssessments();\n    expect(piaResult.highRiskProcessing.assessed).toBe(true);\n    expect(piaResult.mitigationMeasures.implemented).toBe(true);\n    expect(piaResult.documentation.complete).toBe(true);\n    \n    // Test data protection officer responsibilities\n    const dpoResult = await privacyAuditor.auditDPOResponsibilities();\n    expect(dpoResult.dpoAppointed).toBe(true);\n    expect(dpoResult.independentPosition).toBe(true);\n    expect(dpoResult.contactInformation.published).toBe(true);\n  });\n\n  it('should validate cross-border data transfer compliance', async () => {\n    const privacyAuditor = new PrivacyAuditor();\n    \n    // Test adequacy decisions\n    const adequacyResult = await privacyAuditor.auditDataTransfers();\n    expect(adequacyResult.adequacyDecisions.verified).toBe(true);\n    expect(adequacyResult.standardContractualClauses.inPlace).toBe(true);\n    expect(adequacyResult.bindingCorporateRules.compliant).toBe(true);\n    \n    // Test transfer documentation\n    const documentationResult = await privacyAuditor.auditTransferDocumentation();\n    expect(documentationResult.transferRegister.maintained).toBe(true);\n    expect(documentationResult.legalBasis.documented).toBe(true);\n    expect(documentationResult.safeguards.appropriate).toBe(true);\n  });\n\n  it('should validate vendor privacy compliance', async () => {\n    const vendorAuditor = new VendorPrivacyAuditor();\n    \n    // Get list of data processing vendors\n    const vendors = await vendorAuditor.getDataProcessingVendors();\n    \n    for (const vendor of vendors) {\n      // Verify data processing agreements\n      const dpaResult = await vendorAuditor.auditDataProcessingAgreement(vendor.id);\n      expect(dpaResult.dpaExists).toBe(true);\n      expect(dpaResult.gdprCompliant).toBe(true);\n      expect(dpaResult.processingInstructions.documented).toBe(true);\n      \n      // Verify security measures\n      const securityResult = await vendorAuditor.auditVendorSecurity(vendor.id);\n      expect(securityResult.securityCertifications.valid).toBe(true);\n      expect(securityResult.dataBreachProcedures.documented).toBe(true);\n      expect(securityResult.incidentNotification.timely).toBe(true);\n      \n      // Verify subprocessor management\n      const subprocessorResult = await vendorAuditor.auditSubprocessors(vendor.id);\n      expect(subprocessorResult.subprocessorList.maintained).toBe(true);\n      expect(subprocessorResult.consentObtained.documented).toBe(true);\n    }\n  });\n});\n```\n\n## Automated Compliance Monitoring\n\n### Compliance Dashboard\n```typescript\nclass ComplianceDashboard {\n  async generateComplianceReport(): Promise<ComplianceReport> {\n    const [gdpr, soc2, ccpa, privacy] = await Promise.all([\n      this.assessGDPRCompliance(),\n      this.assessSOC2Compliance(),\n      this.assessCCPACompliance(),\n      this.assessPrivacyCompliance()\n    ]);\n    \n    return {\n      overall: this.calculateOverallScore([gdpr, soc2, ccpa, privacy]),\n      frameworks: {\n        gdpr: {\n          score: gdpr.score,\n          status: gdpr.status,\n          gaps: gdpr.gaps,\n          lastAssessment: gdpr.timestamp\n        },\n        soc2: {\n          score: soc2.score,\n          status: soc2.status,\n          gaps: soc2.gaps,\n          lastAssessment: soc2.timestamp\n        },\n        ccpa: {\n          score: ccpa.score,\n          status: ccpa.status,\n          gaps: ccpa.gaps,\n          lastAssessment: ccpa.timestamp\n        },\n        privacy: {\n          score: privacy.score,\n          status: privacy.status,\n          gaps: privacy.gaps,\n          lastAssessment: privacy.timestamp\n        }\n      },\n      recommendations: this.generateRecommendations([gdpr, soc2, ccpa, privacy]),\n      nextReviewDate: this.calculateNextReviewDate()\n    };\n  }\n  \n  private calculateOverallScore(assessments: ComplianceAssessment[]): number {\n    const totalScore = assessments.reduce((sum, assessment) => sum + assessment.score, 0);\n    return totalScore / assessments.length;\n  }\n}\n```\n\n### Continuous Compliance Monitoring\n```typescript\nclass ContinuousComplianceMonitor {\n  private monitors: ComplianceMonitor[] = [];\n  \n  startMonitoring(): void {\n    // Real-time data access monitoring\n    this.monitors.push(new DataAccessMonitor({\n      alertThreshold: 100, // Alert if >100 access requests per hour\n      suspiciousPatterns: ['bulk_download', 'after_hours_access'],\n      autoResponse: true\n    }));\n    \n    // Consent compliance monitoring\n    this.monitors.push(new ConsentComplianceMonitor({\n      trackWithdrawals: true,\n      validatePurpose: true,\n      auditFrequency: 'daily'\n    }));\n    \n    // Data retention monitoring\n    this.monitors.push(new RetentionComplianceMonitor({\n      enforceRetention: true,\n      alertBeforeExpiry: 30, // 30 days warning\n      auditDeletions: true\n    }));\n    \n    // Third-party compliance monitoring\n    this.monitors.push(new VendorComplianceMonitor({\n      assessmentFrequency: 'quarterly',\n      contractReview: true,\n      securityValidation: true\n    }));\n  }\n  \n  async getComplianceAlerts(): Promise<ComplianceAlert[]> {\n    const alerts = [];\n    \n    for (const monitor of this.monitors) {\n      const monitorAlerts = await monitor.getAlerts();\n      alerts.push(...monitorAlerts);\n    }\n    \n    return alerts.sort((a, b) => b.severity - a.severity);\n  }\n}\n```\n\n## Success Criteria\n\n### Compliance Metrics\n- **Overall Compliance Score**: > 95%\n- **GDPR Compliance**: 100% for all applicable requirements\n- **SOC 2 Compliance**: Pass all relevant controls\n- **Data Subject Request Response**: < 30 days (GDPR requirement)\n- **Incident Response**: < 72 hours notification (GDPR requirement)\n\n### Audit Requirements\n1. **Internal Audits**: Monthly compliance assessments\n2. **External Audits**: Annual third-party compliance audits\n3. **Vendor Assessments**: Quarterly vendor compliance reviews\n4. **Policy Updates**: Bi-annual policy and procedure reviews\n5. **Training Completion**: 100% staff compliance training\n\n## Usage Examples\n\n```bash\n# Run compliance audit\nnpm run compliance:audit\n\n# Generate compliance report\nnpm run compliance:report\n\n# Test GDPR compliance\nnpm run compliance:gdpr-test\n\n# Validate data retention\nnpm run compliance:retention-check\n```\n\n## Best Practices\n\n1. **Continuous Monitoring**: Implement real-time compliance monitoring\n2. **Documentation**: Maintain comprehensive compliance documentation\n3. **Training**: Regular compliance training for all staff\n4. **Vendor Management**: Regular assessment of third-party compliance\n5. **Incident Response**: Clear procedures for compliance incidents\n6. **Regular Reviews**: Periodic review and update of compliance measures\n\n## Related Agents\n- **Security Scanner Agent**: For security compliance\n- **Data Integrity Agent**: For data governance\n- **Recovery Driller Agent**: For business continuity compliance\n- **UX Evaluator Agent**: For accessibility compliance